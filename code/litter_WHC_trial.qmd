---
title: "Litter WHC trial"
author: "Heather Throop"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Overview

This code works up data from the 2022 IRES Microclimate project, litter water holding capacity experiment. Original csv file is pulled in, cleaned, analyzed, and graphed.

File written: 12 July 2025, Heather Throop\
2026-01-29 updated location for reading and writing files - HT

## Preparation Steps

```{r}
#| echo: false
#| label: load packages 

library(here) 
library(tidyverse)
library(bestNormalize)
library(car)        # for Levene's test
library(ggplot2)
library(emmeans)    # for post hoc Tukey
library(multcomp) # for compact letter displays of comparisons
```

```{r}
# Use the stored config file to define the path for the DERT Data & Metadata folder (in ASU Dropbox) 
DERT_Archives <- config::get()
```

## Data Ingestion & Calculations

```{r}
#| label: read in data and calculate derived variables
litterWHC_df <- read_csv(file.path(DERT_Archives, 
    "NSF_IRES", "2022_Littermicroclimate", "HT_compiled", "data", "litter_WHC.csv"))
litterWHC_df <- na.omit(litterWHC_df)

#calculate derived moisture variables
litterWHC_df <- litterWHC_df |>
  mutate(
    # calculate litter dry mass for each sample (no bag)
    LitterDryMassnoBag = LitterDryMasswBag - Bag_Mass, 
    WHC = ((MassT0noBag - LitterDryMassnoBag)/LitterDryMassnoBag)*100
  )

# explore WHC data with a histogram
hist(litterWHC_df$WHC,
     main = "Histogram of Litter Water Holding Capacity",
     xlab = "WHC (% by mass)",
     col = "skyblue",
     border = "white",
     breaks = 20)

litterWHC_df <- litterWHC_df |>
  filter(WHC <= 300)

# recode species names to functional types
litterWHC_df$Species <- as.factor(litterWHC_df$Species)
litterWHC_df$Species <- dplyr::recode(litterWHC_df$Species,
                               "SAPE" = "shrub",
                               "STSA" = "grass")
```

## Data Plotting

```{r}
#| label: WHC plot

# Create a dataframe for interaction labels
label_df <- litterWHC_df |>
  dplyr::distinct(Species, LitterCond) |>
  dplyr::arrange(Species, LitterCond) |>
  dplyr::mutate(
    Letters = c("a", "b", "a", "c"),   # letters in order
    WHC = c(175, 190, 145, 80)  # position above bars
  )

p_WHC <- litterWHC_df |>
    ggplot(aes(x = Species, y = WHC, fill = LitterCond)) +
      geom_boxplot() +
      scale_fill_manual(values = c("green" = "#2E8B57", "brown" = "#8B4513")) +
      labs(
        x = "Species",
        y = "Litter Water Holding Capacity (% by mass)",
        fill = ""
    ) +
    theme_classic(base_size = 20)+
    theme(legend.position = c(0.2, 0.2))  +# Adjust position as needed
    geom_text(
      data = label_df,
      aes(x = Species, y = WHC, 
          label = Letters, group = LitterCond),
      position = position_dodge(width = 0.75),   # align with boxplot dodging
      size = 6,
      inherit.aes = FALSE)
p_WHC

# save the plot
ggsave(filename = file.path(DERT_Archives, "NSF_IRES", "2022_Littermicroclimate", 
                            "HT_compiled", "output", "figures", "litter_WHC.jpg"),
      plot = p_WHC,
       width = 8, height = 6, dpi = 300)
```

## Data Analysis

```{r}
#| label: ANOVA assumptions

# Step 1: Check normality of WHC
hist(litterWHC_df$WHC, main = "Histogram of WHC", xlab = "WHC")
qqnorm(litterWHC_df$WHC); qqline(litterWHC_df$WHC)
shapiro_test <- shapiro.test(litterWHC_df$WHC)
print(shapiro_test)

# Step 2: Transform WHC if not normal
if (shapiro_test$p.value < 0.05) {
  bn_obj <- bestNormalize(litterWHC_df$WHC)
  litterWHC_df$WHC_trans <- predict(bn_obj)
  used_var <- "WHC_trans"
  message("Data was transformed using: ", bn_obj$chosen_transform)
} else {
  used_var <- "WHC"
  message("No transformation applied.")
}

# Create interaction term for grouping
litterWHC_df <- litterWHC_df |>
  mutate(Group = interaction(Species, LitterCond))

# Run Levene's test
leveneTest(get(used_var) ~ Group, data = litterWHC_df)
```

```{r}
#| label: two-way ANOVA

# Two-way ANOVA model
aov_model <- aov(reformulate(c("Species", "LitterCond", "Species:LitterCond"), used_var), data = litterWHC_df)
summary(aov_model)

# Tukey pairwise comparisons for main effects and interaction
emm <- emmeans(aov_model, ~ Species * LitterCond)

# Main effect comparisons
tukey_species <- pairs(emmeans(aov_model, ~ Species), adjust = "tukey")
tukey_littercond <- pairs(emmeans(aov_model, ~ LitterCond), adjust = "tukey")

# Interaction comparisons
tukey_interaction <- pairs(emm, adjust = "tukey")

# Print results
print(tukey_species)
print(tukey_littercond)
print(tukey_interaction)

# Optional: plot interaction
emmip(emm, Species ~ LitterCond, CIs = TRUE) + 
  labs(y = "Estimated WHC", title = "Interaction Plot: Species Ã— Litter Condition")

# === Compact Letter Displays (CLD) ===

# Species main effect
emm_species <- emmeans(aov_model, ~ Species)
cld_species <- cld(emm_species, adjust = "tukey", Letters = letters, alpha = 0.05)

# LitterCond main effect
emm_littercond <- emmeans(aov_model, ~ LitterCond)
cld_littercond <- cld(emm_littercond, adjust = "tukey", Letters = letters, alpha = 0.05)

# Interaction effect
cld_interaction <- cld(emm, adjust = "tukey", Letters = letters, alpha = 0.05)

# Print results with group letters
print(cld_species)
print(cld_littercond)
print(cld_interaction)

# === Save results including CLDs ===
sink(file.path(DERT_Archives, "NSF_IRES", "2022_Littermicroclimate", 
            "HT_compiled", "output", "stats", "whc_analysis_results.txt"))

cat("===== Two-Way ANOVA Summary =====\n")
print(summary(aov_model))

cat("\n\n===== Tukey Pairwise Comparisons: Species =====\n")
print(tukey_species)
cat("\nCompact Letter Display (Species):\n")
print(cld_species)

cat("\n\n===== Tukey Pairwise Comparisons: LitterCond =====\n")
print(tukey_littercond)
cat("\nCompact Letter Display (LitterCond):\n")
print(cld_littercond)

cat("\n\n===== Tukey Pairwise Comparisons: Interaction =====\n")
print(tukey_interaction)
cat("\nCompact Letter Display (Interaction):\n")
print(cld_interaction)

sink()

```
